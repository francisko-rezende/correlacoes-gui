---
title: "Correlations"
author: "Francisko de Moraes Rezende"
date: "3/4/2021"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Running correlations for Gui

## Setup

### Loading packages

```{r loading-pkgs}
list_of_packages <- c("tidyverse", "readxl", "here", "correlation", "ggstatsplot")
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

library(tidyverse)
library(readxl)
library(here)
library(correlation)
library(ggstatsplot)
```

### Loading data

```{r loading-data}
data_path <- 
  here::here("data")


files <- 
  dir(path = data_path,
      pattern = "*.xls|*.xlsx")

adsorbed_particles <-
files %>% 
  purrr::map(~ readxl::read_excel(file.path(data_path, .))) %>%
  purrr::set_names(nm = c("particle_count",
                          "macro",
                          "micro",
                          "wetability",
                          "celular_perimeter",
                          "ui"
                          ))
```

### Standardising the sheets

```{r}
adsorbed_particles %>% 
  purrr::pluck("particle_count") %>% 
  dplyr::rename(sp = Sp,
                face = Face,
                frag = Frag,
                site = Site) %>% 
  dplyr::mutate(
    site = dplyr::case_when(
    site == "BR" ~ 1,
    site == "CA" ~ 2,
    site == "VZ" ~ 3,
    site == "CN" ~ 4,
    site == "REF" ~ 5),
    `<2.5` = as.numeric(`<2.5`),
    `2.5-10` = as.numeric(`2.5-10`),
    `10-100` = as.numeric(`10-100`),
    total = `<2.5` + `2.5-10` + `10-100`) -> adsorbed_particles$particle_count
```

```{r}
adsorbed_particles %>%
  purrr::pluck("particle_count") %>%
  dplyr::group_by(site, sp, Rep, face) %>%
  dplyr::summarise(
    `<2.5` = mean(`<2.5`),
    `2.5-10` = mean(`2.5-10`),
    `10-100` = mean(`10-100`),
    total = mean(total)
  ) %>%
  dplyr::ungroup() -> adsorbed_particles$particle_count_micro
```


```{r}
adsorbed_particles %>% 
  purrr::pluck("micro") %>% 
  dplyr::rename(ind = rep) -> adsorbed_particles$micro
```

```{r}
adsorbed_particles %>% 
  purrr::pluck("macro") %>% 
  dplyr::select(-Rq) -> adsorbed_particles$macro
```

```{r}
adsorbed_particles %>% 
  purrr::pluck("micro") %>% 
  dplyr::select(-Sq) -> adsorbed_particles$micro
```


### Combining sheets

#### Combining microroughness sheets

```{r} 
adsorbed_particles %>% 
  purrr::keep(stringr::str_detect(names(.), pattern = "micro")) %>% 
  purrr::reduce(left_join) %>% 
  dplyr::rename(rep = Rep) -> micro_combined
```

#### Combining all vars but microroughness

```{r}
adsorbed_particles %>% 
  purrr::discard(stringr::str_detect(names(.), pattern = "micro")) %>% 
  purrr::reduce(left_join) %>% 
  dplyr::rename(rep = Rep) -> all_but_micro_combined
```
## Analyses

### Defining functions I used

Since there's load of repetition in these analyses, I defined functions to make maintaining the code easier.

The following function calculates the pearson correlation between `leaf_char` and `part_size` for a given dataset (`dat`).

```{r}
calculates_correlation <- function(dat, leaf_char, part_size) {

  common_vars <- c("sp", "site", "face", "rep")
  
  dat %>% 
    select(all_of(common_vars), {{leaf_char}}, {{part_size}}) %>% 
    group_by(site, sp, face, rep)  %>%
    summarise(mean({{leaf_char}}), mean({{part_size}})) %>% 
    ungroup() %>% 
    correlation()
}
```

```{r}
plots_scatterplot <- function(dat, leaf_char, part_size) {

  common_vars <- c("sp", "site", "face", "rep")
  
  dat %>% 
    select(all_of(common_vars), {{leaf_char}}, {{part_size}}) %>% 
    group_by(site, sp, face, rep)  %>%
    summarise(mean_char = mean({{leaf_char}}), mean_part = mean({{part_size}})) %>% 
    ggplot2::ggplot(., aes(x = mean_char, y = mean_part)) +
    ggplot2::geom_point(alpha = 0.7)
}
```

<!-- ```{r} -->
<!-- plots_statsplot <- function(dat, leaf_char, part_size) { -->

<!--   common_vars <- c("sp", "site", "face", "rep") -->

<!--   dat %>%  -->
<!--     select(all_of(common_vars), {{leaf_char}}, {{part_size}}) %>%  -->
<!--     group_by(site, sp, face, rep)  %>% -->
<!--     summarise(mean_char = mean({{leaf_char}}), mean_part = mean({{part_size}})) %>%  -->
<!--   ggstatsplot::ggscatterstats( -->
<!--     data = ., -->
<!--     x = {{leaf_char}}, -->
<!--     y = {{part_size}} -->
<!--   ) -->
<!-- } -->
<!-- ``` -->


### Microroughness

#### Correcting microroughness sheet

I forgot to change `sp`, `site`, `face` and `rep` to factors so I'll do it now:

```{r}
common_vars <- c("sp", "site", "face", "rep")

micro_combined %>%
  dplyr::mutate(across(.cols = all_of(common_vars), .fns = forcats::as_factor)) -> micro_combined
```

#### < 2.5

##### Correlation

```{r}
calculates_correlation(micro_combined, Sa, `<2.5`)
```


##### Plot

```{r}
plots_scatterplot(micro_combined, Sa, `<2.5`) +
  labs(y = "Number of adsorbed particles (<2.5)",
       x = "Sa")
```

```{r}
plots_statsplot(micro_combined, Sa, `<2.5`)
```



#### 2.5 - 10

##### Correlation

```{r}
calculates_correlation(micro_combined, Sa, `2.5-10`)
```

##### Plot

```{r}
plots_scatterplot(micro_combined, Sa, `2.5-10`) +
  labs(
    x = "Sa",
    y = "Number of adsorbed particles (2.5 - 10)"
  )
```


#### 10 - 100

##### Correlation

```{r}
calculates_correlation(micro_combined, Sa, `10-100`)
```

##### Plot

```{r}
plots_scatterplot(micro_combined, Sa, `10-100`) +
  labs(
    x = "Sa",
    y = "Number of adsorbed particles (10-100)"
  )
```

#### Total

##### Correlation

```{r}
calculates_correlation(micro_combined, Sa, total)
```
##### Plot




```{r}
plots_scatterplot(micro_combined, Sa, total) +
  labs(
    x = "Sa",
    y = "Total number of Adsorbed particles"
  )
```

#### Correcting all vars but microroughness sheet

```{r}
common_vars <- c("sp", "site", "face", "rep")

all_but_micro_combined %>%
  dplyr::mutate(across(.cols = all_of(common_vars), .fns = forcats::as_factor)) -> all_but_micro_combined
```

### Macroroughness

#### <2.5

##### Correlation

```{r}
calculates_correlation(all_but_micro_combined, Ra, `<2.5`)
```

##### Plot

```{r}
plots_scatterplot(all_but_micro_combined, Ra, `<2.5`)
```

#### 2.5 - 10

##### Correlation

```{r}
calculates_correlation(all_but_micro_combined, Ra, `2.5-10`)
```
##### Plot

```{r}
plots_scatterplot(all_but_micro_combined, Ra, `2.5-10`)
```

#### 10 - 100

##### Correlation

```{r}
calculates_correlation(all_but_micro_combined, Ra, `10-100`)
```

##### Plot

```{r}
plots_scatterplot(all_but_micro_combined, Ra, `10-100`)
```

#### Total

##### Correlation

```{r}
calculates_correlation(all_but_micro_combined, Ra, total)
```

##### Plot 

```{r}
plots_scatterplot(all_but_micro_combined, Ra, total)
```




<!-- ```{r} -->
<!-- micro_combined %>%  -->
<!--   select(common_vars, Sa, `<2.5`) %>%  -->
<!--   group_by(site, sp, face, rep) %>% -->
<!--   summarise(mean_sa =mean(Sa), mean_part = mean(`<2.5`)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- adsorbed_particles %>%  -->
<!--   pluck("particle_count_micro") %>%  -->
<!--   mutate(across(.cols = all_of(c("sp", "face", "site", "Rep")), as_factor)) %>% -->
<!--   summary() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- adsorbed_particles %>%  -->
<!--   pluck("micro") %>%  -->
<!--   mutate(across(all_of(c("sp", "ind", "frag", "face")), as.factor)) %>%  -->
<!--   summary() -->
<!-- ``` -->


<!-- ```{r} -->
<!-- adsorbed_particles %>%  -->
<!--   pluck("particle_count") %>%  -->
<!--   mutate(across(.cols = all_of(c("sp", "face", "site", "frag", "Rep")), as_factor)) %>%  -->
<!--   summary() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- adsorbed_particles %>%  -->
<!--   pluck("macro") %>%  -->
<!--   mutate(across(all_of(c("sp", "ind", "frag", "face")), as.factor)) %>%  -->
<!--   summary() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- common_vars <- c("sp", "site", "face", "rep") -->

<!--   micro_combined %>%  -->
<!--     select(all_of(common_vars), Sa, `<2.5`) %>%  -->
<!--     group_by(site, sp, face, rep)  %>% -->
<!--     summarise(mean_sa = mean(Sa), mean_particle = mean(`<2.5`)) %>%  -->
<!--     ggplot2::ggplot(., aes(x = mean_sa, y = mean_particle)) + -->
<!--     ggplot2::geom_point() -->
<!-- ``` -->
